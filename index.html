<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£ä¹¦ AI åŠ©æ‰‹</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            margin: 0;
        }
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #e8e8e8;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #40a9ff;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .hint {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }
        .btn {
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            margin-right: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        .btn-primary:hover {
            background: #40a9ff;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d9d9d9;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
        }
        .status.ok {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .status.loading {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        .status.info {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }
        .chat-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.user {
            background: #1890ff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.ai {
            background: #f0f0f0;
            color: #333;
        }
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e8e8e8;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #666;
        }
        .tab.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .webhook-url-box {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .webhook-url-box code {
            background: transparent;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– é£ä¹¦ AI åŠ©æ‰‹</h1>
        <p>åŸºäºæ™ºè°± AI (GLM-4) çš„æ™ºèƒ½å¯¹è¯æœåŠ¡</p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ AI å¯¹è¯</div>
        <div class="tab" onclick="switchTab('config')">âš™ï¸ é…ç½®</div>
        <div class="tab" onclick="switchTab('about')">â„¹ï¸ å…³äº</div>
    </div>

    <!-- AI å¯¹è¯ Tab -->
    <div id="chat-tab" class="tab-content active">
        <div class="card">
            <h2>å‘é€æ¶ˆæ¯ç»™ AI</h2>
            <div class="form-group">
                <label for="userMessage">ä½ çš„æ¶ˆæ¯:</label>
                <textarea id="userMessage" placeholder="è¾“å…¥ä½ æƒ³å¯¹ AI è¯´çš„è¯..."></textarea>
            </div>
            <button onclick="sendMessage()" class="btn btn-primary">ğŸš€ å‘é€ç»™ AI</button>
            <button onclick="clearChat()" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
            <div id="chatStatus" class="status info" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>å¯¹è¯å†å²</h2>
            <div id="chatHistory" class="chat-history">
                <p style="color: #999; text-align: center;">æš‚æ— å¯¹è¯è®°å½•</p>
            </div>
        </div>
    </div>

    <!-- é…ç½® Tab -->
    <div id="config-tab" class="tab-content">
        <div class="card">
            <h2>é£ä¹¦æœºå™¨äººé…ç½®</h2>
            <div class="form-group">
                <label for="feishuWebhook">é£ä¹¦æœºå™¨äºº Webhook URL:</label>
                <input type="text" id="feishuWebhook" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/xxx">
                <p class="hint">
                    è·å–æ–¹å¼ï¼šé£ä¹¦ç¾¤èŠ â†’ è®¾ç½® â†’ ç¾¤æœºå™¨äºº â†’ æ·»åŠ æœºå™¨äºº â†’ å¤åˆ¶ Webhook åœ°å€
                </p>
            </div>
            <button onclick="saveConfig()" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button onclick="testWebhook()" class="btn btn-secondary">ğŸ“¡ æµ‹è¯•è¿æ¥</button>
            <div id="configStatus" class="status info" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>GitHub Token é…ç½®ï¼ˆå¯é€‰ï¼‰</h2>
            <div class="form-group">
                <label for="githubToken">GitHub Personal Access Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <p class="hint">
                    ç”¨äºè§¦å‘ GitHub Actions å·¥ä½œæµã€‚å¦‚æœä¸å¡«ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆä»…æ˜¾ç¤ºï¼Œä¸å®é™…è°ƒç”¨ï¼‰ã€‚
                    <br>è·å–æ–¹å¼ï¼šGitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens
                </p>
            </div>
            <button onclick="saveGitHubToken()" class="btn btn-primary">ğŸ’¾ ä¿å­˜ Token</button>
        </div>
    </div>

    <!-- å…³äº Tab -->
    <div id="about-tab" class="tab-content">
        <div class="card">
            <h2>å…³äºæœ¬é¡¹ç›®</h2>
            <p><strong>é£ä¹¦ AI åŠ©æ‰‹</strong>æ˜¯ä¸€ä¸ªåŸºäº GitHub Pages å’Œ GitHub Actions çš„æ™ºèƒ½å¯¹è¯æœåŠ¡ã€‚</p>
            
            <h3 style="margin-top: 20px;">å·¥ä½œåŸç†</h3>
            <ol>
                <li>ç”¨æˆ·åœ¨ç½‘é¡µè¾“å…¥æ¶ˆæ¯</li>
                <li>é€šè¿‡ GitHub API è§¦å‘ Actions å·¥ä½œæµ</li>
                <li>Actions è°ƒç”¨æ™ºè°± AI (GLM-4) ç”Ÿæˆå›å¤</li>
                <li>AI å›å¤é€šè¿‡é£ä¹¦æœºå™¨äººå‘é€åˆ°ç¾¤èŠ</li>
            </ol>

            <h3 style="margin-top: 20px;">æŠ€æœ¯æ ˆ</h3>
            <ul>
                <li>å‰ç«¯ï¼šHTML + CSS + JavaScript (çº¯é™æ€é¡µé¢)</li>
                <li>åç«¯ï¼šGitHub Actions</li>
                <li>AI æœåŠ¡ï¼šæ™ºè°± AI (GLM-4-Flash)</li>
                <li>æ¶ˆæ¯æ¨é€ï¼šé£ä¹¦æœºå™¨äºº Webhook</li>
            </ul>

            <div class="webhook-url-box">
                <strong>æœ¬é¡¹ç›®åœ°å€ï¼š</strong><br>
                <code>https://github.com/lylgxy888/feishu-webhook</code>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å­˜å‚¨é”®å
        const CONFIG_KEYS = {
            FEISHU_WEBHOOK: 'feishuWebhookUrl',
            GITHUB_TOKEN: 'githubToken',
            CHAT_HISTORY: 'chatHistory'
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadChatHistory();
        });

        // Tab åˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–° Tab æ ·å¼
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(elementId, type, message) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // éšè—çŠ¶æ€æ¶ˆæ¯
        function hideStatus(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const feishuWebhook = localStorage.getItem(CONFIG_KEYS.FEISHU_WEBHOOK);
            const githubToken = localStorage.getItem(CONFIG_KEYS.GITHUB_TOKEN);

            if (feishuWebhook) {
                document.getElementById('feishuWebhook').value = feishuWebhook;
            }
            if (githubToken) {
                document.getElementById('githubToken').value = githubToken;
            }
        }

        // ä¿å­˜é£ä¹¦é…ç½®
        function saveConfig() {
            const webhookUrl = document.getElementById('feishuWebhook').value.trim();

            if (!webhookUrl) {
                showStatus('configStatus', 'error', 'è¯·è¾“å…¥é£ä¹¦æœºå™¨äºº Webhook URL');
                return;
            }

            if (!webhookUrl.startsWith('https://open.feishu.cn/open-apis/bot/v2/hook/')) {
                showStatus('configStatus', 'error', 'Webhook URL æ ¼å¼ä¸æ­£ç¡®');
                return;
            }

            localStorage.setItem(CONFIG_KEYS.FEISHU_WEBHOOK, webhookUrl);
            showStatus('configStatus', 'ok', 'âœ… é…ç½®å·²ä¿å­˜ï¼');
        }

        // ä¿å­˜ GitHub Token
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value.trim();

            if (!token) {
                showStatus('configStatus', 'error', 'è¯·è¾“å…¥ GitHub Token');
                return;
            }

            localStorage.setItem(CONFIG_KEYS.GITHUB_TOKEN, token);
            showStatus('configStatus', 'ok', 'âœ… GitHub Token å·²ä¿å­˜ï¼');
        }

        // æµ‹è¯•é£ä¹¦ Webhook
        async function testWebhook() {
            const webhookUrl = document.getElementById('feishuWebhook').value.trim();

            if (!webhookUrl) {
                showStatus('configStatus', 'error', 'è¯·å…ˆé…ç½®é£ä¹¦æœºå™¨äºº Webhook URL');
                return;
            }

            showStatus('configStatus', 'loading', 'â³ å‘é€æµ‹è¯•æ¶ˆæ¯...');

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        msg_type: 'text',
                        content: {
                            text: 'ğŸ¤– é£ä¹¦ AI åŠ©æ‰‹æµ‹è¯•æ¶ˆæ¯\næ—¶é—´: ' + new Date().toLocaleString()
                        }
                    })
                });

                if (response.ok) {
                    showStatus('configStatus', 'ok', 'âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥é£ä¹¦ç¾¤èŠ');
                } else {
                    const errorText = await response.text();
                    showStatus('configStatus', 'error', `âŒ å‘é€å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                showStatus('configStatus', 'error', `âŒ å‘é€å¼‚å¸¸: ${error.message}`);
            }
        }

        // å‘é€æ¶ˆæ¯ç»™ AI
        async function sendMessage() {
            const message = document.getElementById('userMessage').value.trim();
            const feishuWebhook = localStorage.getItem(CONFIG_KEYS.FEISHU_WEBHOOK);
            const githubToken = localStorage.getItem(CONFIG_KEYS.GITHUB_TOKEN);

            if (!message) {
                showStatus('chatStatus', 'error', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            if (!feishuWebhook) {
                showStatus('chatStatus', 'error', 'è¯·å…ˆé…ç½®é£ä¹¦æœºå™¨äºº Webhook');
                switchTab('config');
                return;
            }

            // æ·»åŠ åˆ°å¯¹è¯å†å²
            addMessage('user', message);
            document.getElementById('userMessage').value = '';

            showStatus('chatStatus', 'loading', 'â³ æ­£åœ¨è°ƒç”¨ AIï¼Œè¯·ç¨å€™...');

            // å¦‚æœæœ‰ GitHub Tokenï¼Œå°è¯•è§¦å‘ Actions
            console.log('GitHub Token:', githubToken ? 'å·²é…ç½®' : 'æœªé…ç½®');
            if (githubToken) {
                try {
                    await triggerGitHubActions(message, feishuWebhook, githubToken);
                    showStatus('chatStatus', 'ok', 'âœ… æ¶ˆæ¯å·²å‘é€ç»™ AIï¼Œå›å¤å°†æ¨é€åˆ°é£ä¹¦ç¾¤èŠ');
                } catch (error) {
                    console.error('è§¦å‘ GitHub Actions å¤±è´¥:', error);
                    showStatus('chatStatus', 'error', 'âŒ è°ƒç”¨å¤±è´¥: ' + error.message);
                    // æ¨¡æ‹Ÿ AI å›å¤
                    setTimeout(() => simulateAIReply(message), 1000);
                }
            } else {
                // æ¨¡æ‹Ÿæ¨¡å¼
                console.log('è¿›å…¥æ¨¡æ‹Ÿæ¨¡å¼');
                showStatus('chatStatus', 'info', 'â„¹ï¸ æ¨¡æ‹Ÿæ¨¡å¼ï¼šæœªé…ç½® GitHub Tokenï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿå›å¤');
                setTimeout(() => simulateAIReply(message), 1500);
            }
        }

        // è§¦å‘ GitHub Actions
        async function triggerGitHubActions(message, feishuWebhook, token) {
            console.log('æ­£åœ¨è§¦å‘ GitHub Actions...');
            console.log('æ¶ˆæ¯:', message);
            
            const response = await fetch('https://api.github.com/repos/lylgxy888/feishu-webhook/dispatches', {
                method: 'POST',
                headers: {
                    'Accept': 'application/vnd.github.v3+json',
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'X-GitHub-Api-Version': '2022-11-28'
                },
                body: JSON.stringify({
                    event_type: 'feishu_message',
                    client_payload: {
                        message: message,
                        session_id: 'web_' + Date.now(),
                        feishu_webhook: feishuWebhook
                    }
                })
            });

            console.log('GitHub API å“åº”çŠ¶æ€:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('GitHub API é”™è¯¯è¯¦æƒ…:', errorText);
                throw new Error(`GitHub API é”™è¯¯: ${response.status} - ${errorText}`);
            }
            
            console.log('GitHub Actions è§¦å‘æˆåŠŸ!');
        }

        // æ¨¡æ‹Ÿ AI å›å¤ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        function simulateAIReply(userMessage) {
            const replies = [
                'æ”¶åˆ°ä½ çš„æ¶ˆæ¯ï¼š"' + userMessage + '"\n\næˆ‘æ˜¯ AI åŠ©æ‰‹ï¼Œæ­£åœ¨ä¸ºä½ æœåŠ¡ï¼',
                'ä½ å¥½ï¼æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ï¼š"' + userMessage + '"\n\næœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ',
                'æ„Ÿè°¢ä½ çš„æ¶ˆæ¯ï¼\n\nä½ è¯´ï¼š"' + userMessage + '"\n\næˆ‘ä¼šå°½å¿«ä¸ºä½ å¤„ç†ã€‚'
            ];
            const randomReply = replies[Math.floor(Math.random() * replies.length)];
            addMessage('ai', randomReply);
            hideStatus('chatStatus');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å†å²
        function addMessage(role, content) {
            const historyDiv = document.getElementById('chatHistory');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…ç©ºæç¤ºæ–‡å­—
            if (historyDiv.querySelector('p')) {
                historyDiv.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const time = new Date().toLocaleString();
            messageDiv.innerHTML = `
                <div>${escapeHtml(content)}</div>
                <div class="message-time">${time}</div>
            `;

            historyDiv.appendChild(messageDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // ä¿å­˜åˆ° localStorage
            saveChatHistory();
        }

        // è½¬ä¹‰ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ä¿å­˜å¯¹è¯å†å²
        function saveChatHistory() {
            const historyDiv = document.getElementById('chatHistory');
            const messages = [];
            historyDiv.querySelectorAll('.message').forEach(msg => {
                messages.push({
                    role: msg.classList.contains('user') ? 'user' : 'ai',
                    content: msg.querySelector('div').textContent,
                    time: msg.querySelector('.message-time').textContent
                });
            });
            localStorage.setItem(CONFIG_KEYS.CHAT_HISTORY, JSON.stringify(messages));
        }

        // åŠ è½½å¯¹è¯å†å²
        function loadChatHistory() {
            const saved = localStorage.getItem(CONFIG_KEYS.CHAT_HISTORY);
            if (saved) {
                const messages = JSON.parse(saved);
                const historyDiv = document.getElementById('chatHistory');
                historyDiv.innerHTML = '';
                
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role}`;
                    messageDiv.innerHTML = `
                        <div>${escapeHtml(msg.content)}</div>
                        <div class="message-time">${msg.time}</div>
                    `;
                    historyDiv.appendChild(messageDiv);
                });
                
                historyDiv.scrollTop = historyDiv.scrollHeight;
            }
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                document.getElementById('chatHistory').innerHTML = '<p style="color: #999; text-align: center;">æš‚æ— å¯¹è¯è®°å½•</p>';
                localStorage.removeItem(CONFIG_KEYS.CHAT_HISTORY);
                hideStatus('chatStatus');
            }
        }
    </script>
</body>
</html>
