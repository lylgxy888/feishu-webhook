name: Feishu Webhook

on:
  repository_dispatch:
    types: [message]

jobs:
  handle-message:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Feishu Message
        uses: actions/github-script@v7
        with:
          script: |
            const data = ${{ github.event }};
            console.log('收到消息:', JSON.stringify(data, null, 2));

            // 转发到 OpenClaw Gateway
            try {
              const gatewayUrl = 'http://127.0.0.1:18789';
              const response = await fetch(gatewayUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  type: 'message',
                  channel: 'feishu',
                  channel_id: 'webhook',
                  sender_type: data.sender?.sender_type || 'user',
                  text: data.text?.content || '无文本内容',
                  raw_message: data,
                  timestamp: Date.now()
                })
              });

              const result = await response.json();
              console.log('Gateway 回复:', result);

              // 发送回复到飞书
              const feishuWebhookUrl = 'https://open.feishu.cn/open-apis/bot/v2/hook/fda77564-40f5-4410-8560-450c8c2b03b5';
              await fetch(feishuWebhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  msg_type: 'text',
                  content: JSON.stringify({
                    text: result.text || 'AI 回复中...'
                  })
                })
              });

              console.log('回复已发送到飞书');
            } catch (error) {
              console.error('处理消息失败:', error);
            }
